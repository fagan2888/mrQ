function Fit=pd_CVtest_voxels(g,pBasis,M0_v,plotFlag,TruePar,TruePD,FigNum)

ifNotDe
nCoils=size(M0_v,2);

%estimate PD from the coil gain and M0 data
[PD, G] = pdEstimate(M0_v, pBasis, g);

G  = G  .* PD(1);
PD = PD ./ PD(1);

%get the M0 prediction
M0 = G.*repmat( PD(:),1,nCoils);
%calculate the fit error
Fit.M0prederr=M0-M0_v;
Fit.Meanerr=mean(abs(Fit.M0prederr));

fprintf(' the mean abs error fit  % 0.f  \n :',Fit.Meanerr);

if ~notDefined('TruePD')
    Fit.RMSE = sqrt(mean(  (TruePD(:)./mean(TruePD(:))-PD(:)./mean(PD(:))   ).^2));
    fprintf(' the PD  RMSE % 0.3f  \n :',  Fit.RMSE);
    
end

Fit.PD=PD;
Fit.M0=M0;

%plot
if plotFlag==1
    
    mrvNewGraphWin;plot(Fit.M0prederr./M0_v,'.');
    title('M0 pracent error')
    
    
    
    if notDefined('TruePar')
        
    else
            figH = mrvNewGraphWin;

        Par=TruePar;
        str='True gains';
    
    CoefNorm=Par(1)./g(1);
    
    % Plot the starting point
    figure(figH);
    subplot(1,2,1); plot(g(:).*CoefNorm,Par(:),'.')
    identityLine(gca);
    xlabel('Estimated gains'); ylabel(str);
    
    subplot(1,2,2); plot(PD(:),TruePD(:),'.');set(gca,'ylim',[min(PD(:))*0.9 max(PD(:))*1.1]);
    xlabel('Estimated PD');ylabel('true PD');
    
end
end